-----SILVER LAYER 
---RAW AND UNPROCESSED---
----DDL CREATAING TABLE 
USE DataWarehouse
GO

IF EXISTS(SELECT 1 FROM SYS.DATABASES WHERE NAME='DATAWAREHOUSE')
 BEGIN
     ALTER DATABASE DATAWAREHOUSE SET SINGLE USER WITH ROLLBACK IMMEDIATE;
  DROP DATABASE DATAWAREHOUSE;
END;
GO

IF OBJECT_ID('SILVER.CRM_CUST_INFO','U') IS NOT NULL
DROP TABLE SILVER.CRM_CUST_INFO;
CREATE TABLE SILVER.CRM_CUST_INFO(
CST_ID INT,
CST_KEY NVARCHAR(50),
CST_FIRSTNAME NVARCHAR(50),
CST_LASTNAME NVARCHAR(50),
CST_MARETIAL_STATUS VARCHAR(10),
CST_GENDER NVARCHAR(50),
CST_CREATE_DATE  DATE
);


IF OBJECT_ID('SILVER.CRM_PROD_INFO','U') IS NOT NULL
DROP TABLE SILVER.CRM_PROD_INFO;

CREATE TABLE SILVER.CRM_PROD_INFO(
PRD_ID INT,
PRD_KEY NVARCHAR(50),
PRD_NAME VARCHAR(50),
PRD_COST BIGINT,
PRD_LINE NVARCHAR(20),
PRD_START_DATE DATE,
PRD_END_DATE DATE

)


IF OBJECT_ID('SILVER.CRM_SALE_DETAILS','U') IS NOT NULL
DROP TABLE SILVER.CRM_SALE_DETAILS;


CREATE TABLE SILVER.CRM_SALE_DETAILS(
sls_ord_num NVARCHAR(50),
SLS_PROD_KEY NVARCHAR(50),
SLS_CUST_ID INT,
SLS_ORDER_DT INT,
SLS_SHIP_DT INT,
SLS_DUE_DT INT,
SLS_SALES INT,
SLS_QUANTITY INT,
SLS_PRICE INT
);


IF OBJECT_ID('SILVER.ERP_CUST_AZ12','U') IS NOT NULL
DROP TABLE SILVER.ERP_CUST_AZ12;
CREATE TABLE SILVER.ERP_CUST_AZ12(
CID NVARCHAR(50),
BDATE DATE,
GEN NVARCHAR(50)
);



IF OBJECT_ID('SILVER.ERP_LOC_A101','U') IS NOT NULL
DROP TABLE SILVER.ERP_LOC_A101;
CREATE TABLE SILVER.ERP_LOC_A101(
CID NVARCHAR(50),
COUNTRY NVARCHAR(50)
);


IF OBJECT_ID('SILVER.ERP_PX_CAT_G1V2','U') IS NOT NULL
DROP TABLE SILVER.ERP_PX_CAT_G1V2;
CREATE TABLE SILVER.ERP_PX_CAT_G1V2(
ID NVARCHAR(50),
CAT NVARCHAR(50),
SUBCAT NVARCHAR(50),
MAINTENANCE NVARCHAR(50)
)
----/* IN THIS SCRIPT WE INSERT VALUE INTO SILVER.C[CRM_CUST_INFO]
FROM BRONZE.[CRM_CUST_INFO] WITH CLEANING 
REMOVE UNNECESSARY SPACE TO ENSURE DATA CONSISTENCY AND
UNIFORMITY ACRROS ALL RECORDS
DATA NORMALISE  & STANDARDISATION 
MAPS CODESD VALUE TO MEANSINGFULL ,USER FREINDLY DESCRIPTIONS 
LIKE GENDER F,HTEN CONVERT FEMALE
HANDLING MISSING VALUE LIKE FILL IN THE BLANKS BY ADDING A DEFAULT VALUE
REMOVE DUPLICATE ONLY ONE RECORD  PER ENTITY BY IDENTIFYING AND REATIN THE MOST RELEVANT ROW

*/



INSERT INTO [Silver].[CRM_CUST_INFO](
CST_ID,
CST_KEY,
CST_FIRSTNAME,
CST_LASTNAME,
CST_MARETIAL_STATUS,
CST_GENDER,
CST_CREATE_DATE)

SELECT 
CST_ID,
CST_KEY,
TRIM(CST_FIRSTNAME) AS CST_FIRSTNAME,---REMOVING UNWANTED SAPCE
TRIM(CST_LASTNAME) AS CST_LASTNAME,
CASE 
    WHEN UPPER(TRIM(CST_MARETIAL_STATUS))='M'THEN 'MARRIED'
    WHEN UPPER(TRIM(CST_MARETIAL_STATUS))='S'THEN 'SINGLE'
    ELSE 'NA'-------NORMALISE THE VALUE OF MARITAL STATUS
    END AS CST_MARETIAL_STATUS,

CASE WHEN UPPER(TRIM(CST_GENDER))='M'THEN 'MALE'
     WHEN UPPER(TRIM(CST_GENDER))='F'THEN 'FEMALE'
     ELSE 'N/A'
     END AS CST_GNDR,
CST_CREATE_DATE
FROM
(
select *,
ROW_NUMBER()over(partition by CST_ID ORDER BY CST_CREATE_DATE DESC) AS FLAG_LAST
from bronze.CRM_CUST_INFO
WHERE CST_ID IS NOT NULL
)T 
WHERE FLAG_LAST=1 ; ---SELECT THE MOST RECENT RECORD PER CUSTOMER


SELECT *FROM Silver.CRM_CUST_INFO


